/**
 * [Chart.PieceLabel.js]{@link https://github.com/emn178/Chart.PieceLabel.js}
 *
 * @version 0.12.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017-2018
 * @license MIT
 */
(function(){function p(){this.drawDataset=this.drawDataset.bind(this)}function v(a){a.options.pieceLabel&&!a.pieceLabel&&(a.pieceLabel=new p);return a.pieceLabel}"undefined"===typeof Chart?console.warn("Can not find Chart object."):(p.prototype.beforeDatasetsUpdate=function(a){if(this.parseOptions(a)&&"outside"===this.position){var b=1.5*this.fontSize+this.outsidePadding;a.chartArea.top+=b;a.chartArea.bottom-=b}},p.prototype.afterDatasetsDraw=function(a){this.parseOptions(a)&&(this.labelBounds=[],
a.config.data.datasets.forEach(this.drawDataset))},p.prototype.drawDataset=function(a){for(var b=this.ctx,h=this.chartInstance,e=a._meta[Object.keys(a._meta)[0]],k=0,f=0;f<e.data.length;f++){var g=e.data[f],c=g._view;if(0!==c.circumference||this.showZero){switch(this.render){case "value":var d=a.data[f];this.format&&(d=this.format(d));d=d.toString();break;case "label":d=h.config.data.labels[f];break;case "image":d=this.images[f]?this.loadImage(this.images[f]):"";break;default:var m=c.circumference/
this.options.circumference*100;m=parseFloat(m.toFixed(this.precision));this.showActualPercentages||(k+=m,100<k&&(m-=k-100,m=parseFloat(m.toFixed(this.precision))));d=m+"%"}"function"===typeof this.render&&(d=this.render({label:h.config.data.labels[f],value:a.data[f],percentage:m,dataset:a,index:f}),"object"===typeof d&&(d=this.loadImage(d)));if(d){b.save();b.beginPath();b.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily);if("outside"===this.position||"border"===this.position){var l=
c.outerRadius/2;var n=this.fontSize+this.textMargin;var q=c.startAngle+(c.endAngle-c.startAngle)/2;if("border"===this.position)var p=(c.outerRadius-l)/2+l;else"outside"===this.position&&(this.arc||(n=this.textMargin),p=c.outerRadius-l+l+n);q={x:c.x+Math.cos(q)*p,y:c.y+Math.sin(q)*p};if("outside"===this.position){this.arc||(n+=this.measureText(d).width/2);q.x=q.x<c.x?q.x-n:q.x+n;var r=c.outerRadius+n}}else l=c.innerRadius,q=g.tooltipPosition();n=this.fontColor;"function"===typeof n?n=n({label:h.config.data.labels[f],
value:a.data[f],percentage:m,text:d,backgroundColor:a.backgroundColor[f],dataset:a,index:f}):"string"!==typeof n&&(n=n[f]||this.options.defaultFontColor);if(this.arc)r||(r=(l+c.outerRadius)/2),b.fillStyle=n,b.textBaseline="middle",this.drawArcText(d,r,c,this.overlap);else{l=this.measureText(d);c=q.x-l.width/2;l=q.x+l.width/2;var t=q.y-this.fontSize/2,u=q.y+this.fontSize/2;(this.overlap||("outside"===this.position?this.checkTextBound(c,l,t,u):g.inRange(c,t)&&g.inRange(c,u)&&g.inRange(l,t)&&g.inRange(l,
u)))&&this.fillText(d,q,n)}b.restore()}}}},p.prototype.parseOptions=function(a){var b=a.options.pieceLabel;return b?(this.chartInstance=a,this.ctx=a.chart.ctx,this.options=a.config.options,this.render=b.render||b.mode,this.position=b.position||"default",this.arc=b.arc,this.format=b.format,this.precision=b.precision||0,this.fontSize=b.fontSize||this.options.defaultFontSize,this.fontColor=b.fontColor||this.options.defaultFontColor,this.fontStyle=b.fontStyle||this.options.defaultFontStyle,this.fontFamily=
b.fontFamily||this.options.defaultFontFamily,this.shadowOffsetX=b.shadowOffsetX||3,this.shadowOffsetY=b.shadowOffsetY||3,this.shadowColor=b.shadowColor||"rgba(0,0,0,0.3)",this.shadowBlur=b.shadowBlur||6,this.textShadow=b.textShadow||!1,this.hasTooltip=a.tooltip._active&&a.tooltip._active.length,this.showZero=b.showZero,this.overlap=b.overlap,this.images=b.images||[],this.outsidePadding=b.outsidePadding||2,this.textMargin=b.textMargin||2,this.showActualPercentages=b.showActualPercentages||!1,!0):!1},
p.prototype.checkTextBound=function(a,b,h,e){for(var k=this.labelBounds,f=0;f<k.length;++f){for(var g=k[f],c=[[a,h],[a,e],[b,h],[b,e]],d=0;d<c.length;++d){var m=c[d][0],l=c[d][1];if(m>=g.left&&m<=g.right&&l>=g.top&&l<=g.bottom)return!1}c=[[g.left,g.top],[g.left,g.bottom],[g.right,g.top],[g.right,g.bottom]];for(d=0;d<c.length;++d)if(m=c[d][0],l=c[d][1],m>=a&&m<=b&&l>=h&&l<=e)return!1}k.push({left:a,right:b,top:h,bottom:e});return!0},p.prototype.measureText=function(a){return"object"===typeof a?{width:a.width,
height:a.height}:this.ctx.measureText(a)},p.prototype.fillText=function(a,b,h){var e=this.ctx;"object"===typeof a?e.drawImage(a,b.x-a.width/2,b.y-a.height/2,a.width,a.height):(e.fillStyle=h,e.textBaseline="top",e.textAlign="center",this.textShadow&&(e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY,e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur),e.fillText(a,b.x,b.y-this.fontSize/2),e.shadowBlur=0,e.shadowColor="rgba(0,0,0,0)")},p.prototype.loadImage=function(a){var b=
new Image;b.src=a.src;b.width=a.width;b.height=a.height;return b},p.prototype.drawArcText=function(a,b,h,e){var k=this.ctx,f=h.x,g=h.y,c=h.startAngle;h=h.endAngle;k.save();k.translate(f,g);g=h-c;c+=Math.PI/2;h+=Math.PI/2;var d=c;f=this.measureText(a);c+=(h-(f.width/b+c))/2;if(e||!(h-c>g))if("string"===typeof a)for(k.rotate(c),e=0;e<a.length;e++)c=a.charAt(e),f=k.measureText(c),k.save(),k.translate(0,-1*b),k.fillText(c,0,0),k.restore(),k.rotate(f.width/b);else k.rotate((d+h)/2),k.translate(0,-1*b),
this.fillText(a,{x:0,y:0});k.restore()},Chart.pluginService.register({beforeDatasetsUpdate:function(a){v(a)&&a.pieceLabel.beforeDatasetsUpdate(a)},afterDatasetsDraw:function(a){v(a)&&a.pieceLabel.afterDatasetsDraw(a)}}))})();
